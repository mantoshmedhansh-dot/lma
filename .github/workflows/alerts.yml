name: Production Alerts

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  API_PRODUCTION_URL: ${{ vars.API_PRODUCTION_URL }}

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Check API Health
        id: api-health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_PRODUCTION_URL }}/health || echo "000")
          echo "status_code=$response" >> $GITHUB_OUTPUT
          if [ "$response" != "200" ]; then
            echo "unhealthy=true" >> $GITHUB_OUTPUT
          else
            echo "unhealthy=false" >> $GITHUB_OUTPUT
          fi

      - name: Get Health Details
        if: steps.api-health.outputs.unhealthy == 'true'
        id: health-details
        run: |
          details=$(curl -s ${{ env.API_PRODUCTION_URL }}/health || echo '{"error": "Failed to fetch"}')
          echo "details<<EOF" >> $GITHUB_OUTPUT
          echo "$details" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Send Slack Alert
        if: steps.api-health.outputs.unhealthy == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Production API Health Check Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Production API Alert"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nUnhealthy"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*HTTP Code:*\n${{ steps.api-health.outputs.status_code }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL:* ${{ env.API_PRODUCTION_URL }}/health"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Time:* ${{ github.event.repository.updated_at || 'N/A' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Render Dashboard"
                      },
                      "url": "https://dashboard.render.com"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Sentry"
                      },
                      "url": "https://sentry.io"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

      - name: Create GitHub Issue
        if: steps.api-health.outputs.unhealthy == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Production API Health Check Failed - ${new Date().toISOString()}`;
            const body = `
            ## Alert Details

            - **Status Code**: ${{ steps.api-health.outputs.status_code }}
            - **URL**: ${{ env.API_PRODUCTION_URL }}/health
            - **Time**: ${new Date().toISOString()}

            ## Health Check Response
            \`\`\`json
            ${{ steps.health-details.outputs.details || 'Unable to fetch details' }}
            \`\`\`

            ## Actions
            - [ ] Check Render dashboard for service status
            - [ ] Check Sentry for recent errors
            - [ ] Check Supabase for database issues
            - [ ] Verify environment variables

            ---
            *This issue was automatically created by the health check workflow.*
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'production-alert'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['production-alert', 'urgent']
              });
            }
        continue-on-error: true

      - name: Fail if unhealthy
        if: steps.api-health.outputs.unhealthy == 'true'
        run: exit 1
